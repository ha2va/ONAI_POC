{% extends 'base.html' %}
{% block content %}
<h1>Plan Recommendation</h1>
<form method="post" id="plan-form">
    <div>
        출발지 :
        <select name="origin_type" id="origin_type">
            {% for t in types %}
            <option value="{{ t }}" {% if t == origin_type %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
        </select>
        <select name="origin_id" id="origin_id"></select>
        출발일 <input type="date" name="start_date" value="{{ start_date }}">
    </div>
    <div>
        도착지 :
        <select name="dest_type" id="dest_type">
            {% for t in types %}
            <option value="{{ t }}" {% if t == dest_type %}selected{% endif %}>{{ t }}</option>
            {% endfor %}
        </select>
        <select name="dest_id" id="dest_id"></select>
        도착일 <input type="date" name="end_date" value="{{ end_date }}">
    </div>
    <div>
        Weight <input type="number" step="0.01" name="weight" value="{{ weight if weight is not none else '' }}">
        Requires Freezing <input type="checkbox" name="requires_freezing" value="1" {% if requires_freezing %}checked{% endif %}>
        Dangerous Goods <input type="checkbox" name="is_dangerous" value="1" {% if is_dangerous %}checked{% endif %}>
    </div>
    <button type="submit">Plan 추천</button>
</form>
{% if plans is not none %}

    <p>적용 정책 : {% if applied_policies %}{{ applied_policies|join(', ') }}{% else %}적용된 정책이 없습니다{% endif %}</p>

    {% if plans %}
    <p>Available routes after policy: {{ plans|length }}</p>
    {% for plan in plans %}
        <h3>Plan {{ loop.index }} - Routes: {{ plan.routes|length }}, Recommended Start: {{ plan.recommended_start }}, Cost Sum: {{ plan.total_cost }}, Lead Time Sum: {{ plan.total_lead_time }}</h3>
        <table class="table table-bordered table-sm">
            <tr>
                <th>#</th><th>Route ID</th><th>Origin</th><th>Destination</th><th>Tariff ID</th><th>Cost</th><th>Lead Time</th><th>Freezing</th><th>Dangerous</th>
            </tr>
            {% for r in plan.routes %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ r['id'] }}</td>
                <td>{{ r['origin_name'] }}</td>
                <td>{{ r['destination_name'] }}</td>
                <td><span class="tariff" data-id="{{ r['tariff_id'] }}">{{ r['tariff_id'] if r['tariff_id'] is not none else 'N/A' }}</span></td>
                <td>{{ r['tariff_cost'] if r['tariff_cost'] is not none else 'N/A' }}</td>
                <td>{{ r['lead_time'] }}</td>
                <td>{{ r['supports_freezing'] }}</td>
                <td>{{ r['supports_dangerous_goods'] }}</td>
            </tr>
            {% endfor %}
        </table>
    {% endfor %}
    {% else %}
    <p>조건에 만족하는 경로가 없습니다.</p>
    {% endif %}
{% endif %}
<div id="tariff-tooltip" style="position:absolute;display:none;border:1px solid #ccc;background:#fff;padding:4px;font-size:0.9em;"></div>
<script>
const locations = {{ locations|tojson }};
function populate(typeId, nameId, selected){
    const typeVal = document.getElementById(typeId).value;
    const nameSel = document.getElementById(nameId);
    nameSel.innerHTML = '';
    locations.filter(l => l.type === typeVal).forEach(l => {
        const opt = document.createElement('option');
        opt.value = l.id;
        opt.textContent = l.name;
        if(selected && selected == l.id){
            opt.selected = true;
        }
        nameSel.appendChild(opt);
    });
}
window.addEventListener('load', () => {
    populate('origin_type','origin_id','{{ origin_id }}');
    populate('dest_type','dest_id','{{ dest_id }}');
    document.getElementById('origin_type').addEventListener('change', () => populate('origin_type','origin_id'));
    document.getElementById('dest_type').addEventListener('change', () => populate('dest_type','dest_id'));

    const tooltip = document.getElementById('tariff-tooltip');
    document.querySelectorAll('.tariff').forEach(el => {
        el.addEventListener('mouseenter', async (e) => {
            const id = el.dataset.id;
            if(!id){ return; }
            const res = await fetch(`/tariff/${id}`);
            if(res.ok){
                const data = await res.json();
                tooltip.innerHTML = `Cost: ${data.cost}<br>Valid: ${data.valid_from} - ${data.valid_to}`;
                tooltip.style.display = 'block';
            }
        });
        el.addEventListener('mousemove', (e) => {
            tooltip.style.left = e.pageX + 'px';
            tooltip.style.top = e.pageY + 'px';
        });
        el.addEventListener('mouseleave', () => {
            tooltip.style.display = 'none';
        });
    });

    document.getElementById('plan-form').addEventListener('submit', (e) => {
        const start = document.querySelector('input[name="start_date"]').value;
        const end = document.querySelector('input[name="end_date"]').value;
        if(!start || !end){
            alert('출발일과 도착일을 선택하세요.');
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
